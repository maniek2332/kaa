# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

name: 'Make wheel'
trigger:
- azure-pipelines

jobs:
- job: build_linux
  displayName: "Build Linux wheel"
  pool:
    vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
        python.version_tag: 'py36'
      Python37:
        python.version: '3.7'
        python.version_tag: 'py37'
      Python38:
        python.version: '3.8'
        python.version_tag: 'py38'
  variables:
    docker_image: "quay.io/pypa/manylinux2010_x86_64"
    platform.name: 'linux'
  steps:
  - template: templates/common_checkout_repository.yml
  - template: templates/common_prepare_python.yml
  - task: DockerInstaller@0
    displayName: Docker Installer
    inputs:
      dockerVersion: 17.09.0-ce
      releaseType: stable
  - script: |
      touch _build_version.py
      python -c 'import versioneer; versioneer.write_to_version_file("_build_version.py", versioneer.get_versions())'
      sudo docker pull $(docker_image)
      sudo docker run -v $(System.DefaultWorkingDirectory):/host $(docker_image) \
        /bin/bash /host/scripts/docker_wheel_builder.sh $(python.version_tag)
    displayName: 'Wheel build manylinux2010'
  - template: templates/common_store_wheel.yml
  - template: templates/common_test_wheel.yml

- job: build_windows
  displayName: "Build Windows wheel"
  pool:
    vmImage: 'vs2017-win2016'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
        python.version_tag: 'py36'
      Python37:
        python.version: '3.7'
        python.version_tag: 'py37'
      Python38:
        python.version: '3.8'
        python.version_tag: 'py38'
  variables:
    platform.name: 'windows'
  steps:
  - template: templates/common_checkout_repository.yml
  - template: templates/common_prepare_python.yml
  - script: |
      python setup.py bdist_wheel -d wheelhouse -G "Visual Studio 15 2017 Win64"
    displayName: 'Build wheel'
  - template: templates/common_store_wheel.yml
  - template: templates/common_test_wheel.yml

- job: upload
  displayName: 'Upload wheel'
  dependsOn:
  - build_linux
  - build_windows
  pool:
    vmImage: 'ubuntu-16.04'
  variables:
  - group: pypi-credentials-test
  steps:
  - download: current
    patterns: '**/*.whl'
    # downloads go to: $(Pipeline.Workspace)/{artifact_name}
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
    displayName: 'Use Python 3.7'
  - script: |
      python -m pip install --upgrade pip
      python -m pip install twine
    displayName: 'Install twine'
  - script: |
      echo $(Pipeline.Workspace)/build_*/*.whl
      zip -jv kaa_gathered_builds.zip $(Pipeline.Workspace)/build_*/*.whl
    displayName: 'Prepare gathered ZIP'
  - publish: kaa_gathered_builds.zip
    artifact: "builds_gathered"
  - script: |
      echo "User: $TWINE_USERNAME"
      echo "URL: $TWINE_REPOSITORY_URL"
      python -m twine upload $(Pipeline.Workspace)/build_*/*.whl
    displayName: 'Twine Upload'
